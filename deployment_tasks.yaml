# The task modifies hiera data to have right set cinder-types
- id: netapp_hiera_override
  type: puppet
  version: 2.1.0
  groups: [primary-controller, controller]
  requires: [hiera]
  required_for: [create-cinder-types]
  parameters:
    puppet_manifest: puppet/manifests/hiera_override.pp
    puppet_modules:  puppet/modules:/etc/puppet/modules
    timeout: 360

# Execute on controllers only if ceph enabled
- id: netapp_cinder_controller
  type: puppet
  version: 2.1.0
  groups: [primary-controller, controller]
  requires: [openstack-cinder]
  required_for: [deploy_end]
  condition:
    yaql_exp: "$.storage.volumes_ceph and changed($.cinder_netapp)"
  parameters:
    puppet_manifest: puppet/manifests/site.pp
    puppet_modules:  puppet/modules:/etc/puppet/modules
    timeout: 360

- id: netapp_cinder
  type: puppet
  version: 2.1.0
  groups: [cinder]
  requires: [top-role-cinder]
  required_for: [deploy_end]
  condition:
    yaql_exp: "changed($.cinder_netapp)"
  parameters:
    puppet_manifest: puppet/manifests/site.pp
    puppet_modules:  puppet/modules:/etc/puppet/modules
    timeout: 360

- id: netapp_compute
  type: puppet
  version: 2.1.0
  groups: [compute]
  requires: [top-role-compute]
  required_for: [deploy_end]
  condition:
    yaql_exp: "changed($.cinder_netapp)"
  parameters:
    puppet_manifest: puppet/manifests/compute.pp
    puppet_modules:  puppet/modules:/etc/puppet/modules
    timeout: 360

- id: deleting_old_cinder_volume_services
  type: shell
  version: 2.1.0
  groups: [primary-controller]
  requires: [post_deployment_start]
  required_for: [post_deployment_end]
  parameters:
    cmd: >
      . /root/openrc &&
      for host in $(cinder service-list |
                    grep 'cinder-volume.*enabled.*down' |
                    awk '{ print $4}');
      do cinder-manage service remove cinder-volume $host; done
    retries: 3
    interval: 20
    timeout: 180
